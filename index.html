<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload XLS Workbook</title>
  <!-- Include the XLSX library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Corrected: Include Cheetah Grid CSS and JS -->
  <link href="https://unpkg.com/cheetah-grid@2.5.2/dist/cheetah-grid.css" rel="stylesheet" />
  <script src="https://unpkg.com/cheetah-grid@1.14" defer></script>
</head>
<body>
  <h1>Upload an XLS Workbook</h1>
  <!-- File input for XLS file upload -->
  <input type="file" id="upload" accept=".xls, .xlsx" />

  <!-- Div to render the grid -->
  <div id="grid" style="width: 100%; height: 500px;"></div>

  <!-- Main script to handle file upload and grid initialization -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM fully loaded and parsed');

      const uploadInput = document.getElementById('upload');
      uploadInput.addEventListener('change', handleFile, false);
      console.log('File input event listener attached');
    });

    function handleFile(event) {
      console.log('File selected for upload');
      const file = event.target.files[0];

      if (!file) {
        console.log('No file selected');
        return;
      }

      const reader = new FileReader();
      console.log('Reading file as array buffer');

      reader.onload = function(event) {
        try {
          console.log('File read completed, processing data');
          const data = new Uint8Array(event.target.result);

          console.log('Data loaded, reading workbook');
          const workbook = XLSX.read(data, { type: 'array' });

          console.log('Workbook loaded successfully:', workbook);

          const firstSheetName = workbook.SheetNames[0];
          if (!firstSheetName) {
            console.error('No sheets found in the uploaded file.');
            alert('The uploaded file has no sheets.');
            return;
          }

          console.log('First sheet name:', firstSheetName);

          const worksheet = workbook.Sheets[firstSheetName];
          if (!worksheet) {
            console.error('First sheet could not be loaded.');
            alert('Unable to load the first sheet.');
            return;
          }

          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          console.log('Sheet data converted to JSON:', jsonData);

          if (jsonData.length > 0) {
            console.log('Initializing Cheetah Grid with data');
            initializeCheetahGrid(jsonData);
          } else {
            console.log('No data found in the sheet.');
            alert('No data found in the sheet.');
          }
        } catch (error) {
          console.error('Error processing file:', error);
          alert('An error occurred while processing the file. Check console for details.');
        }
      };

      reader.onerror = function(event) {
        console.error('Error reading file:', event.target.error);
        alert('Failed to read the file. Please try again.');
      };

      reader.readAsArrayBuffer(file);
    }

    function initializeCheetahGrid(data) {
      const gridDiv = document.getElementById('grid');

      // Define the header based on the first row of data
      const columns = data[0].map(header => ({
        field: header,
        caption: header,
        width: 100,
      }));

      // Prepare the data for Cheetah Grid
      const gridData = data.slice(1).map(row => {
        const rowData = {};
        row.forEach((cell, index) => {
          rowData[data[0][index]] = cell !== undefined ? cell : ''; // Handle undefined cells
        });
        return rowData;
      });

      console.log('Cheetah Grid columns:', columns);
      console.log('Cheetah Grid data:', gridData);

      // Initialize Cheetah Grid
      new cheetahGrid.ListGrid({
        parentElement: gridDiv,
        header: columns,
        records: gridData,
        defaultRowHeight: 24,
        theme: cheetahGrid.themes.default
      });

      console.log('Cheetah Grid initialized successfully');
    }
  </script>
</body>
</html>
